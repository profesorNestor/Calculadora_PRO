<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Calculadora PRO-FX IX (v5)</title>
    
    <!-- Librer√≠as JS -->
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/nerdamer.core.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/Calculus.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/Algebra.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/Solve.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/Extra.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

    <!-- MathJax para renderizar LaTeX -->
    <script>
        MathJax = {
          tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']] },
          svg: { fontCache: 'global' }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    
    <!-- Fuentes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">


    <!-- Estilos CSS unificados y responsivos -->
    <style>
        :root {
            --bg-color: #2c3e50;
            --container-color: #34495e;
            --screen-bg: #1d2b38;
            --text-color: #ecf0f1;
            --text-color-light: #bdc3c7;
            --accent-color-1: #3498db;
            --accent-color-2: #9b59b6;
            --op-key-color: #f39c12;
            --clear-key-color: #e74c3c;
            --eq-key-color: #1abc9c;
            --num-key-bg: #4a637c;
            --func-key-bg: #5f7b97;
            --adv-func-key-bg: #3e566d;
            --shadow-light: rgba(255, 255, 255, 0.1);
            --shadow-dark: rgba(0, 0, 0, 0.4);
            --error-color: #e74c3c;
            --font-main: 'Poppins', sans-serif;
            --font-monospace: 'JetBrains Mono', monospace;
        }

        /* --- TEMAS DE COLOR --- */
        body.theme-matrix { --bg-color: #0D0208; --container-color: #1a1a1a; --screen-bg: #000000; --text-color: #00FF41; --text-color-light: #00b32d; --accent-color-1: #00FF41; --accent-color-2: #39FF14; --op-key-color: #00b32d; --clear-key-color: #c0392b; --eq-key-color: #008f39; --num-key-bg: #111; --func-key-bg: #222; --adv-func-key-bg: #000; }
        body.theme-solar { --bg-color: #f4f6f7; --container-color: #ffffff; --screen-bg: #e5e8e8; --text-color: #212f3c; --text-color-light: #566573; --accent-color-1: #2980b9; --accent-color-2: #8e44ad; --op-key-color: #f39c12; --clear-key-color: #e74c3c; --eq-key-color: #16a085; --num-key-bg: #ecf0f1; --func-key-bg: #d5dbdb; --adv-func-key-bg: #bdc3c7; --shadow-light: rgba(255, 255, 255, 0.8); --shadow-dark: rgba(0, 0, 0, 0.1); }
        body.theme-ruby { --bg-color: #4A0404; --container-color: #780206; --screen-bg: #330101; --text-color: #f5b7b1; --text-color-light: #e6b0aa; --accent-color-1: #E84A5F; --accent-color-2: #FF847C; --op-key-color: #c0392b; --clear-key-color: #922b21; --eq-key-color: #e74c3c; --num-key-bg: #641e16; --func-key-bg: #943126; --adv-func-key-bg: #512e2e; }
        body.theme-ocean { --bg-color: #0B2F3A; --container-color: #115E74; --screen-bg: #082129; --text-color: #E0F7FA; --text-color-light: #b2ebf2; --accent-color-1: #4DD0E1; --accent-color-2: #00ACC1; --op-key-color: #00796B; --clear-key-color: #FF6F61; --eq-key-color: #00BCD4; --num-key-bg: #1A7E91; --func-key-bg: #1E8E9F; --adv-func-key-bg: #0F4C5A; }
        body.theme-dusk { --bg-color: #23153C; --container-color: #44318D; --screen-bg: #190F2C; --text-color: #FDEED9; --text-color-light: #fbe0c3; --accent-color-1: #F47A60; --accent-color-2: #ECB92F; --op-key-color: #F8A055; --clear-key-color: #D95B5B; --eq-key-color: #F47A60; --num-key-bg: #5A45A0; --func-key-bg: #6E55C0; --adv-func-key-bg: #31235E; }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-main); background-color: var(--bg-color); color: var(--text-color);
            display: flex; flex-direction: column; justify-content: flex-start; align-items: center; min-height: 100vh; padding: 1rem;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .calculator-body {
            width: 100%; max-width: 550px; background-color: var(--container-color);
            border-radius: 20px; padding: 1.5rem;
            box-shadow: 10px 10px 30px var(--shadow-dark), -10px -10px 30px var(--shadow-light);
            border: 2px solid var(--accent-color-1);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; position: relative; flex-wrap: wrap; gap: 0.5rem;}
        header h1 {
            font-size: clamp(1.2rem, 4vw, 1.4rem); font-weight: 600;
            background: linear-gradient(45deg, var(--accent-color-1), var(--accent-color-2));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .header-controls { display: flex; align-items: center; gap: 1rem; }
        .angle-selector { display: flex; background-color: var(--screen-bg); border-radius: 8px; overflow: hidden; border: 1px solid var(--adv-func-key-bg); }
        .angle-btn { background: none; border: none; color: var(--text-color); padding: 0.3rem 0.6rem; cursor: pointer; font-weight: 500; font-size: 0.8rem; transition: background-color 0.3s; }
        .angle-btn.active { background-color: var(--accent-color-1); }
        #menu-toggle { cursor: pointer; z-index: 1060; width: 30px; height: 25px; display: flex; flex-direction: column; justify-content: space-between; }
        #menu-toggle .bar { width: 100%; height: 3px; background-color: var(--text-color); border-radius: 3px; transition: all 0.3s ease; }
        #main-menu { position: absolute; top: 100%; right: 0; background-color: var(--container-color); backdrop-filter: blur(5px);
            border-radius: 10px; list-style: none; padding: 0.5rem; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: none; z-index: 1055; }
        #main-menu.active { display: block; }
        #main-menu li { padding: 0.5rem 1rem; }
        #main-menu .menu-item, #main-menu .theme-title { color: var(--text-color); text-decoration: none; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: color 0.2s ease; display: block; }
        #main-menu .menu-item:hover { color: var(--accent-color-1); }
        .theme-selector { display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; padding-top: 0.5rem; }
        .theme-btn { width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--text-color); cursor: pointer; }
        
        .screen { background-color: var(--screen-bg); border-radius: 10px; padding: 1rem;
            box-shadow: inset 5px 5px 10px var(--shadow-dark); margin-bottom: 1.5rem; transition: background-color 0.3s ease; }
        .input-display { width: 100%; padding: 0.5rem; font-family: var(--font-monospace); font-size: clamp(1.5rem, 8vw, 2rem); background: transparent;
            border: none; color: var(--text-color); text-align: right; }
        .output-section { min-height: 70px; padding-top: 1rem; border-top: 1px solid var(--accent-color-1); transition: border-color 0.3s ease;}
        #output { font-size: clamp(1.2rem, 5vw, 1.5rem); text-align: center; overflow-x: auto; word-wrap: break-word; }
        #error-message { color: var(--error-color); text-align: center; margin-top: 0.5rem; font-weight: 500; display: none; }
        
        .keypad-container { display: flex; flex-direction: column; gap: 0.75rem; }
        .function-pad, .number-pad { display: grid; gap: 0.5rem; }
        .function-pad { grid-template-columns: repeat(6, 1fr); }
        .number-pad { grid-template-columns: repeat(4, 1fr); }
        .keypad-button {
            padding: 0.8rem 0; font-size: 1rem; font-weight: 500; color: var(--text-color);
            border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s ease;
            box-shadow: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light);
            display: flex; justify-content: center; align-items: center; background-color: var(--func-key-bg);
            -webkit-tap-highlight-color: transparent;
        }
        .keypad-button:active { transform: scale(0.95); box-shadow: inset 2px 2px 5px var(--shadow-dark); }
        .keypad-button sup { font-size: 0.55em; position: relative; top: -0.6em; margin-left: 1px; }
        .num-key { background-color: var(--num-key-bg); }
        .op-key { background-color: var(--op-key-color); font-size: 1.2rem; }
        .clear-key { background-color: var(--clear-key-color); }
        .eq-key { background-color: var(--eq-key-color); }
        .equals-key { background: linear-gradient(145deg, var(--accent-color-1), var(--accent-color-2)); font-size: 1.5rem; grid-column: span 2; }

        .advanced-controls { margin-top: 1rem; padding-top: 1rem; border-top: 2px solid var(--bg-color);
            display: grid; grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); gap: 0.5rem; }
        .adv-button { background-color: var(--adv-func-key-bg); padding: 0.7rem; font-size: 0.8rem; text-align: center; }
        #limit-controls { display: none; grid-column: 1 / -1; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem; }
        
        /* --- Modal Gen√©rico --- */
        .modal {
            display: none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            align-items: center; justify-content: center; animation: fadeIn 0.3s;
        }
        .modal.active { display: flex; }
        .modal-content {
            background-color: var(--container-color); margin: auto; padding: 1.5rem; border: 1px solid var(--shadow-light);
            width: 95%; max-width: 900px; border-radius: 15px; position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); animation: slide-down 0.4s ease-out; 
            max-height: 90vh; display: flex; flex-direction: column;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slide-down { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; border-bottom: 1px solid var(--shadow-light); flex-shrink: 0;}
        .modal-title { font-size: 1.5rem; color: var(--accent-color-1); font-weight: 600; }
        .modal-close { font-size: 2rem; font-weight: bold; cursor: pointer; color: var(--text-color); transition: color 0.2s, transform 0.2s; background: none; border: none; line-height: 1; padding: 0; }
        .modal-close:hover { color: var(--accent-color-1); transform: rotate(90deg); }

        .modal-body { padding-top: 1rem; overflow-y: auto; flex-grow: 1; }

        .modal-content h3 { font-size: 1.25rem; margin-bottom: 1rem; color: var(--accent-color-2);}
        .modal-content label, .modal-content .label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .modal-content input, .modal-content select, .modal-content textarea {
            width: 100%; padding: 0.75rem; border-radius: 8px; font-size: 1rem;
            background-color: var(--screen-bg); color: var(--text-color);
            border: 1px solid var(--adv-func-key-bg); transition: border-color 0.2s;
        }
        .modal-content input:focus, .modal-content select:focus, .modal-content textarea:focus { outline: none; border-color: var(--accent-color-1); }
        .modal-content .modal-button {
            background: linear-gradient(145deg, var(--accent-color-1), var(--accent-color-2));
            color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px;
            font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease;
            display: block; width: 100%;
        }
        .modal-content .modal-button:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .modal-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; }
        
        /* --- Estilos de M√≥dulos Espec√≠ficos --- */
        .tab-button{transition:.2s;border-bottom:3px solid transparent}
        .tab-button.active{border-bottom-color:var(--accent-color-1);color:var(--accent-color-1)}
        .page-content{display:none}.page-content.active{display:block;animation:fadeIn .4s}

        .truth-table, #statistics-modal table { font-family: var(--font-monospace); border-collapse: collapse; width: 100%; font-size: .9em; }
        .truth-table th, .truth-table td, #statistics-modal th, #statistics-modal td { border: 1px solid var(--adv-func-key-bg); padding: 6px 10px; text-align: center; }
        .truth-table th, #statistics-modal th { background: var(--adv-func-key-bg); }
        .truth-table td.T { color: var(--eq-key-color); font-weight: bold; }
        .truth-table td.F { color: var(--clear-key-color); font-weight: bold; }

        #statistics-modal .median-class { background-color: #3498db33 !important; }
        #statistics-modal .mode-class { border: 2px solid var(--op-key-color); }

        .element-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 8px; max-height: 180px; overflow-y: auto; background: var(--screen-bg); padding: 1rem; border-radius: 12px; margin-top: 10px; }
        .element-option { display: flex; align-items: center; justify-content: center; padding: 10px; background: var(--func-key-bg); border-radius: 10px; cursor: pointer; transition: all 0.2s ease; font-size: 1.1em; border: 2px solid transparent; color: var(--text-color); font-weight: 700; min-height: 45px; box-shadow: 0 2px 4px var(--shadow-dark); }
        .element-option.selected { background: var(--accent-color-1); color: #ffffff; border-color: #ffffff; transform: scale(1.05); }

        #combinatorics-modal .results-scroll-container { max-height: 250px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-top: 1rem;}
        #combinatorics-modal .combination-row { display: flex; align-items: center; background: #00000020; padding: 5px; border-radius: 5px; margin-bottom: 5px; }
        #combinatorics-modal .combination-row span:first-child { color: var(--accent-color-1); margin-right: 10px; font-size: 0.8em; }
        #combinatorics-modal .combination-row .element { background: var(--op-key-color); color: white; padding: 2px 8px; border-radius: 4px; margin: 2px; }

        .result-box { margin-top: 1rem; padding: 1rem; border-radius: 8px; font-weight: bold; border-left: 4px solid; word-wrap: break-word; }
        .result-box.success { background: #1abc9c20; border-color: var(--eq-key-color); color: var(--text-color); }
        .result-box.error { background: #e74c3c20; border-color: var(--clear-key-color); color: var(--error-color); }

        .system-solver-grid { display: grid; gap: 0.5rem 1rem; align-items: center; margin-bottom: 1.5rem; }
        .system-solver-grid.grid-2x2 { grid-template-columns: auto auto auto auto auto; }
        .system-solver-grid.grid-3x3 { grid-template-columns: auto auto auto auto auto auto auto; }
        .system-solver-grid input { width: 60px; text-align: center; }


        footer {
            width: 100%; text-align: center; padding-top: 1.5rem; margin-top: 1.5rem;
            color: var(--text-color-light); font-size: 0.9rem; font-weight: 500;
            border-top: 1px solid var(--accent-color-2);
        }
    </style>
</head>
<body>
    <div class="calculator-body">
        <header>
            <h1>Super Calculadora PRO-FX IX</h1>
            <div class="header-controls">
                <div id="angle-mode-selector" class="angle-selector">
                    <button class="angle-btn active" data-mode="deg">D</button>
                    <button class="angle-btn" data-mode="rad">R</button>
                    <button class="angle-btn" data-mode="grad">G</button>
                </div>
                <div id="menu-toggle"><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>
            </div>
            <nav>
                <ul id="main-menu">
                    <li><span class="menu-item" data-modal="combinatorics-modal">üßÆ Combinatoria</span></li>
                    <li><span class="menu-item" data-modal="logic-sets-modal">üß© L√≥gica y Conjuntos</span></li>
                    <li><span class="menu-item" data-modal="probability-modal">üé≤ Probabilidades</span></li>
                    <li><span class="menu-item" data-modal="distributions-modal">üìä Distribuciones</span></li>
                    <li><span class="menu-item" data-modal="statistics-modal">üìà Estad√≠stica</span></li>
                    <li style="border-top: 1px solid var(--shadow-light); margin: 0.5rem 0;"></li>
                    <li><span class="menu-item" data-modal="help-modal">Ayuda</span></li>
                    <li class="theme-title" style="padding-top: 0.5rem;">Temas</li>
                    <li class="theme-selector">
                        <button class="theme-btn" data-theme="default" style="background-color: #34495e;"></button>
                        <button class="theme-btn" data-theme="theme-matrix" style="background-color: #00FF41;"></button>
                        <button class="theme-btn" data-theme="theme-solar" style="background-color: #f1c40f;"></button>
                        <button class="theme-btn" data-theme="theme-ruby" style="background-color: #c0392b;"></button>
                        <button class="theme-btn" data-theme="theme-ocean" style="background-color: #00BCD4;"></button>
                        <button class="theme-btn" data-theme="theme-dusk" style="background-color: #F47A60;"></button>
                    </li>
                </ul>
            </nav>
        </header>

        <main>
            <section class="screen">
                <input type="text" id="function-input" class="input-display" placeholder="0">
                <div class="output-section" id="output-section"><div id="output"></div><p id="error-message"></p></div>
            </section>
            
            <div class="keypad-container">
                <div class="function-pad">
                    <!-- Fila 1 -->
                    <button class="keypad-button func-key" data-value="sin(">sin</button>
                    <button class="keypad-button func-key" data-value="cos(">cos</button>
                    <button class="keypad-button func-key" data-value="tan(">tan</button>
                    <button class="keypad-button func-key" data-value="asin(">sin‚Åª¬π</button>
                    <button class="keypad-button func-key" data-value="acos(">cos‚Åª¬π</button>
                    <button class="keypad-button func-key" data-value="atan(">tan‚Åª¬π</button>
                    <!-- Fila 2 -->
                    <button class="keypad-button func-key" data-value="sinh(">sinh</button>
                    <button class="keypad-button func-key" data-value="cosh(">cosh</button>
                    <button class="keypad-button func-key" data-value="tanh(">tanh</button>
                    <button class="keypad-button func-key" data-value="asinh(">sinh‚Åª¬π</button>
                    <button class="keypad-button func-key" data-value="acosh(">cosh‚Åª¬π</button>
                    <button class="keypad-button func-key" data-value="atanh(">tanh‚Åª¬π</button>
                    <!-- Fila 3 -->
                    <button class="keypad-button func-key" data-value="log(">log‚ÇÅ‚ÇÄ</button>
                    <button class="keypad-button func-key" data-value="log(,)">log‚Çô</button>
                    <button class="keypad-button func-key" data-value="^">x<sup>y</sup></button>
                    <button class="keypad-button func-key" data-value="nthroot(,2)">‚àö</button>
                    <button class="keypad-button func-key" data-value="pi">œÄ</button>
                    <button class="keypad-button func-key" data-value="e">e</button>
                    <!-- Fila 4 -->
                    <button class="keypad-button func-key" data-value="(">(</button>
                    <button class="keypad-button func-key" data-value=")">)</button>
                    <button class="keypad-button func-key" data-value="abs(">abs</button>
                    <button class="keypad-button eq-key" data-value="=">=</button>
                    <button class="keypad-button func-key" data-value="y">y</button>
                    <button class="keypad-button func-key" data-value="z">z</button>
                </div>
                <div class="number-pad">
                    <button class="keypad-button clear-key" data-value="AC">AC</button>
                    <button class="keypad-button clear-key" data-value="DEL">DEL</button>
                    <button class="keypad-button func-key" data-value="x">x</button>
                    <button class="keypad-button op-key" data-value="/">√∑</button>
                    
                    <button class="keypad-button num-key" data-value="7">7</button>
                    <button class="keypad-button num-key" data-value="8">8</button>
                    <button class="keypad-button num-key" data-value="9">9</button>
                    <button class="keypad-button op-key" data-value="*">√ó</button>
                    
                    <button class="keypad-button num-key" data-value="4">4</button>
                    <button class="keypad-button num-key" data-value="5">5</button>
                    <button class="keypad-button num-key" data-value="6">6</button>
                    <button class="keypad-button op-key" data-value="-">‚àí</button>
                    
                    <button class="keypad-button num-key" data-value="1">1</button>
                    <button class="keypad-button num-key" data-value="2">2</button>
                    <button class="keypad-button num-key" data-value="3">3</button>
                    <button class="keypad-button op-key" data-value="+">+</button>

                    <button class="keypad-button num-key" data-value="0">0</button>
                    <button class="keypad-button num-key" data-value=".">.</button>
                    <button class="keypad-button func-key" data-value="S2D">S‚ÜîD</button>
                    <button class="keypad-button equals-key" data-value="EVAL">=</button>
                </div>
            </div>

            <section class="advanced-controls">
                <button class="keypad-button adv-button" data-op="expand">Expandir</button>
                <button class="keypad-button adv-button" data-op="factor">Factorizar</button>
                <button class="keypad-button adv-button" data-op="solve">Resolver Ec.</button>
                <button class="keypad-button adv-button" data-modal="solve-2x2-modal">Sistema 2x2</button>
                <button class="keypad-button adv-button" data-modal="solve-3x3-modal">Sistema 3x3</button>
                <button class="keypad-button adv-button" data-op="diff">Derivar</button>
                <button class="keypad-button adv-button" data-op="integrate">Integrar</button>
                <button class="keypad-button adv-button" data-op="laplace">Laplace</button>
                <button class="keypad-button adv-button" data-op="limit">L√≠mite</button>
            </section>
             <div id="limit-controls">
                <input type="text" id="limit-var" class="input-display" style="font-size: 1rem;" value="x" placeholder="Var">
                <input type="text" id="limit-point" class="input-display" style="font-size: 1rem;" value="0" placeholder="Punto">
            </div>
        </main>
    </div>
    
    <footer><p>Creado por N√©stor Fabio Montoya Palacios & Perfeccionado por Gemini</p></footer>

    <!-- ========== MODALS START ========== -->
    
    <div id="combinatorics-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üßÆ M√≥dulo de Combinatoria</h2>
                <button class="modal-close" data-modal="combinatorics-modal">&times;</button>
            </div>
            <div class="modal-body modal-grid">
                <div>
                    <h3>Configuraci√≥n</h3>
                    <div style="margin-bottom: 1rem;">
                        <label for="combinatorics-calculationType">Tipo de C√°lculo:</label>
                        <select id="combinatorics-calculationType">
                            <option value="variaciones">Variaciones V(n,r)</option>
                            <option value="variacionesRep">Variaciones con Repetici√≥n VR(n,r)</option>
                            <option value="permutaciones">Permutaciones P(n)</option>
                            <option value="permutacionesCirc">Permutaciones Circulares PC(n)</option>
                            <option value="combinaciones">Combinaciones C(n,r)</option>
                            <option value="combinacionesRep">Combinaciones con Repetici√≥n CR(n,r)</option>
                        </select>
                    </div>
                     <div id="combinatorics-rValueGroup" style="margin-bottom: 1rem;">
                        <label for="combinatorics-rValue">Elementos a tomar (r):</label>
                        <input type="number" id="combinatorics-rValue" min="1" max="20" value="3">
                    </div>
                    <div>
                         <label for="combinatorics-elementType">Categor√≠a de Elementos:</label>
                         <select id="combinatorics-elementType">
                            <option value="numbers">üî¢ N√∫meros</option>
                            <option value="letters">üî§ Letras</option>
                            <option value="faces">üòÄ Caras</option>
                            <option value="animals">üê∂ Animales</option>
                            <option value="food">üçé Comida</option>
                            <option value="custom">‚ú® Personalizado</option>
                        </select>
                    </div>
                </div>
                <div>
                     <h3>Elementos Disponibles</h3>
                     <div class="element-grid" id="combinatorics-elementGrid"></div>
                     <div id="combinatorics-custom-input-container" style="display: none; margin-top: 1rem;">
                        <input type="text" id="combinatorics-custom-input" placeholder="a,b,c,d...">
                        <button id="combinatorics-add-custom-btn" class="modal-button" style="margin-top: 0.5rem; font-size: 0.8rem; padding: 0.5rem 1rem;">Agregar</button>
                     </div>
                </div>
                <div style="grid-column: 1 / -1;">
                    <button id="combinatorics-calculate-btn" class="modal-button">üöÄ ¬°Calcular!</button>
                    <div id="combinatorics-results" style="margin-top: 1rem; display: none;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="logic-sets-modal" class="modal">
         <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üß© M√≥dulo de L√≥gica y Conjuntos</h2>
                <button class="modal-close" data-modal="logic-sets-modal">&times;</button>
            </div>
            <div class="modal-body" style="padding-top: 0;">
                <nav style="display: flex; justify-content: center; border-bottom: 2px solid var(--adv-func-key-bg); margin-bottom: 1.5rem;">
                    <button class="tab-button active" data-page="logic-sets-page-sets" style="flex: 1; padding: 0.75rem; background: none; border: none; color: var(--text-color); font-size: 1rem; cursor: pointer;">Conjuntos</button>
                    <button class="tab-button" data-page="logic-sets-page-logic" style="flex: 1; padding: 0.75rem; background: none; border: none; color: var(--text-color); font-size: 1rem; cursor: pointer;">L√≥gica</button>
                </nav>

                <div id="logic-sets-page-sets" class="page-content active">
                     <div class="space-y-6">
                        <!-- 1. Definici√≥n de Conjuntos -->
                        <div>
                            <h3 class="text-xl font-semibold text-indigo-300 mb-3">1. Define tus Conjuntos</h3>
                            <label class="block mb-4">
                                <span class="text-gray-400">Universo (U) - Elementos separados por coma</span>
                                <input id="set-u" class="w-full p-2 mt-1 bg-gray-700 rounded-lg border border-gray-600 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500 outline-none font-mono" placeholder="e.g., 1, 2, 3, 4, 5, 6, 7, 8, 9, 10">
                            </label>
                            <div id="sets-container" class="space-y-3"></div>
                            <button id="add-set-btn" class="mt-4 w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                A√±adir Conjunto
                            </button>
                        </div>

                        <!-- 2. Creaci√≥n de la Expresi√≥n -->
                        <div>
                            <h3 class="text-xl font-semibold text-indigo-300 pt-4 mb-3">2. Crea la Expresi√≥n</h3>
                            <div class="bg-gray-900 rounded-lg p-2">
                                <input id="set-expression" class="w-full bg-transparent p-2 font-mono text-lg text-gray-200 outline-none" placeholder="(A u B) - C'">
                            </div>
                            <div id="set-op-buttons" class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 gap-2 mt-3"></div>
                            <button id="logic-calc-expr-btn" class="w-full mt-4 bg-indigo-600 hover:bg-indigo-700 py-3 rounded-lg font-bold text-lg transition-colors flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.831-.12 2.702-.345"/><path d="M22 12c0-5.5-4.5-10-10-10"/><path d="m15.54 9.1-5.08 5.08"/><path d="m10.46 9.1 5.08 5.08"/></svg>
                                Resolver
                            </button>
                        </div>

                        <!-- 3. Contenedor de Resultado -->
                        <div id="set-result-container" class="hidden pt-4">
                            <h3 class="text-xl font-semibold text-indigo-300">Resultado:</h3>
                            <div id="set-result" class="mt-2 bg-gray-900 p-4 rounded-lg font-mono text-lg text-green-400"></div>
                        </div>
                    </div>
                </div>
                <div id="logic-sets-page-logic" class="page-content" style="display: none;">
                    <div class="space-y-6">
                        <h2 class="text-xl font-semibold text-indigo-300">Generador de Tablas de Verdad</h2>
                        <div class="bg-gray-900 rounded-lg p-2 mt-3">
                            <input id="logic-input" class="w-full bg-transparent p-2 font-mono text-lg text-gray-200 outline-none" placeholder="(p -> q) & (q -> r)">
                        </div>
                        <div id="logic-op-buttons" class="grid grid-cols-5 sm:grid-cols-7 gap-2 mt-3"></div>
                        <button class="w-full bg-indigo-600 hover:bg-indigo-700 py-3 rounded-lg font-bold text-lg mt-4 transition-colors flex items-center justify-center gap-2" id="logic-generate-table-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20V16"/></svg>
                            Generar Tabla
                        </button>
                        <div id="truth-table-result" class="mt-4 text-center text-xl font-bold"></div>
                        <div id="truth-table-container" class="mt-4 overflow-x-auto"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="probability-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 class="modal-title">üé≤ M√≥dulo de Probabilidades</h2><button class="modal-close" data-modal="probability-modal">&times;</button></div>
            <div class="modal-body">
                <section>
                    <h3>ü§î Probabilidad Condicional</h3>
                    <div class="formula" style="font-size: 1.1rem;">$$P(A|B) = \frac{P(A \cap B)}{P(B)}$$</div>
                    <div class="modal-grid">
                        <div>
                            <label for="prob-pA_inter_B_cond">Prob. Intersecci√≥n $P(A \cap B)$:</label>
                            <input type="number" id="prob-pA_inter_B_cond" placeholder="Ej: 0.2" step="0.01" min="0" max="1">
                            <label for="prob-pB_cond" style="margin-top:1rem;">Prob. Condicionante $P(B)$:</label>
                            <input type="number" id="prob-pB_cond" placeholder="Ej: 0.5" step="0.01" min="0" max="1">
                        </div>
                        <div>
                            <button id="prob-calc-cond-btn" class="modal-button">Calcular $P(A|B)$</button>
                            <div id="prob-result-conditional" class="result-box" style="display:none; margin-top: 1rem;"></div>
                        </div>
                    </div>
                </section>
                <hr style="border-color: var(--adv-func-key-bg); margin: 2rem 0;">
                <section>
                    <h3>ü§Ø Teorema de Bayes</h3>
                    <div class="formula" style="font-size: 1.1rem;">$$P(A|B) = \frac{P(B|A) \cdot P(A)}{P(B)}$$</div>
                    <div class="modal-grid">
                        <div>
                            <label for="prob-pB_given_A_bayes">$P(B|A)$ (Verosimilitud):</label>
                            <input type="number" id="prob-pB_given_A_bayes" placeholder="Ej: 0.8" step="0.01" min="0" max="1">
                             <label for="prob-pA_bayes" style="margin-top:1rem;">$P(A)$ (A Priori):</label>
                            <input type="number" id="prob-pA_bayes" placeholder="Ej: 0.3" step="0.01" min="0" max="1">
                             <label for="prob-pB_bayes" style="margin-top:1rem;">$P(B)$ (Evidencia):</label>
                            <input type="number" id="prob-pB_bayes" placeholder="Ej: 0.4" step="0.01" min="0" max="1">
                        </div>
                         <div>
                            <button id="prob-calc-bayes-btn" class="modal-button">Actualizar Creencia</button>
                            <div id="prob-result-bayes" class="result-box" style="display:none; margin-top: 1rem;"></div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <div id="distributions-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 class="modal-title">üìä M√≥dulo de Distribuciones</h2><button class="modal-close" data-modal="distributions-modal">&times;</button></div>
            <div class="modal-body modal-grid">
                <div>
                    <h3>Configuraci√≥n</h3>
                    <label for="dist-distribution">Distribuci√≥n:</label>
                    <select id="dist-distribution">
                        <option value="normal">Normal</option>
                        <option value="binomial">Binomial</option>
                        <option value="poisson">Poisson</option>
                        <option value="chi2">Chi-Cuadrado</option>
                        <option value="tstudent">t de Student</option>
                    </select>
                    <div id="dist-params-container" style="margin-top: 1rem;">
                        <div id="dist-params-normal" class="dist-param-group">
                            <label>Media (Œº):<input type="number" id="dist-normal-mean" step="0.1" value="0"></label>
                            <label>Desv. Est√°ndar (œÉ):<input type="number" id="dist-normal-std" step="0.1" min="0.01" value="1"></label>
                        </div>
                        <div id="dist-params-binomial" class="dist-param-group" style="display:none;">
                            <label>n:<input type="number" id="dist-binomial-n" min="1" value="10"></label>
                            <label>p (0 a 1):<input type="number" id="dist-binomial-p" step="0.01" min="0" max="1" value="0.5"></label>
                        </div>
                        <div id="dist-params-poisson" class="dist-param-group" style="display:none;"><label>Œª (lambda):<input type="number" id="dist-poisson-lambda" step="0.1" min="0" value="3"></label></div>
                        <div id="dist-params-chi2" class="dist-param-group" style="display:none;"><label>Grados de libertad (k):<input type="number" id="dist-chi2-k" min="1" value="3"></label></div>
                        <div id="dist-params-tstudent" class="dist-param-group" style="display:none;"><label>Grados de libertad (ŒΩ):<input type="number" id="dist-t-nu" min="1" value="10"></label></div>
                    </div>

                    <h3 style="margin-top: 1.5rem;">Tipo de Probabilidad</h3>
                    <select id="dist-probType">
                        <option value="equal">P(X = a)</option>
                        <option value="less">P(X ‚â§ a)</option>
                        <option value="greater">P(X ‚â• a)</option>
                        <option value="between">P(a ‚â§ X ‚â§ b)</option>
                    </select>
                    <div id="dist-values-group" style="margin-top: 1rem;">
                        <label>Valor a:<input type="number" id="dist-value-a" step="0.1" value="0"></label>
                        <label id="dist-label-b" style="display:none; margin-top: 0.5rem;">Valor b:<input type="number" id="dist-value-b" step="0.1" value="1"></label>
                    </div>
                </div>
                <div>
                     <h3>Visualizaci√≥n</h3>
                     <div style="width:100%; aspect-ratio: 4/3; background-color: var(--screen-bg); padding: 0.5rem; border-radius: 8px;">
                        <canvas id="dist-chart"></canvas>
                     </div>
                     <button id="dist-calc-btn" class="modal-button" style="margin-top:1rem;">Calcular y Graficar</button>
                     <div id="dist-result" class="result-box" style="display:none; margin-top: 1rem;"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="statistics-modal" class="modal">
        <div class="modal-content">
             <div class="modal-header"><h2 class="modal-title">üìà M√≥dulo de Estad√≠stica</h2><button class="modal-close" data-modal="statistics-modal">&times;</button></div>
             <div class="modal-body">
                <section>
                    <h3 class="text-lg font-semibold mb-3 text-gray-300">1. Ingreso de Datos</h3>
                    <div class="mb-4">
                        <label for="stats-rawData" class="block text-sm font-medium text-gray-400 mb-1">Ingrese los valores num√©ricos separados por comas:</label>
                        <textarea id="stats-rawData" rows="3" class="w-full p-2" placeholder="Ej: 15, 22.5, 18, 30, 25.2, 19, ..."></textarea>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-400 mb-1">M√©todo para calcular el n√∫mero de intervalos (m):</label>
                        <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                            <label class="inline-flex items-center"><input type="radio" name="stats-intervalMethod" value="sqrt" checked class="form-radio h-4 w-4"> <span class="ml-2">Ra√≠z cuadrada de n (m = ‚àön)</span></label>
                            <label class="inline-flex items-center"><input type="radio" name="stats-intervalMethod" value="sturges" class="form-radio h-4 w-4"> <span class="ml-2">Regla de Sturges (m = 1 + 3.3log(n))</span></label>
                        </div>
                    </div>
                    <button id="stats-calculateButton" class="modal-button">Calcular Estad√≠sticas</button>
                    <div id="stats-errorMessages" class="result-box error" style="display:none;"></div>
                </section>
                 <section id="stats-resultsSection" class="hidden mt-4">
                    <h3 class="text-lg font-semibold mb-3 text-gray-300">2. Resultados</h3>
                    <nav id="stats-nav" class="flex flex-wrap gap-2 mb-4 border-b border-gray-700 pb-2">
                         <button data-target="stats-tableOutput" class="nav-button active keypad-button adv-button" style="background:var(--op-key-color)">Tabla</button>
                         <button data-target="stats-measuresOutput" class="nav-button keypad-button adv-button">Medidas</button>
                         <button data-target="stats-histogramOutput" class="nav-button keypad-button adv-button">Histograma</button>
                         <button data-target="stats-polygonOutput" class="nav-button keypad-button adv-button">Pol√≠gono</button>
                         <button data-target="stats-ogiveOutput" class="nav-button keypad-button adv-button">Ojiva</button>
                    </nav>
                    <div id="stats-tableOutput" class="stats-output-section active">
                        <div class="overflow-x-auto"> <table id="stats-frequencyTable"></table> </div>
                    </div>
                    <div id="stats-measuresOutput" class="stats-output-section">
                        <div id="stats-measuresContent" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm"></div>
                    </div>
                    <div id="stats-histogramOutput" class="stats-output-section"><div class="chart-container"><canvas id="stats-histogramChart"></canvas></div></div>
                    <div id="stats-polygonOutput" class="stats-output-section"><div class="chart-container"><canvas id="stats-polygonChart"></canvas></div></div>
                    <div id="stats-ogiveOutput" class="stats-output-section"><div class="chart-container"><canvas id="stats-ogiveChart"></canvas></div></div>
                 </section>
             </div>
        </div>
    </div>
    
    <div id="solve-2x2-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 class="modal-title">Sistema de Ecuaciones 2x2</h2><button class="modal-close" data-modal="solve-2x2-modal">&times;</button></div>
            <div class="modal-body">
                <div class="system-solver-grid grid-2x2">
                    <input type="text" id="a1_2x2" placeholder="a1" value="2"><span>x +</span>
                    <input type="text" id="b1_2x2" placeholder="b1" value="3"><span>y =</span>
                    <input type="text" id="c1_2x2" placeholder="c1" value="8">
                    
                    <input type="text" id="a2_2x2" placeholder="a2" value="5"><span>x +</span>
                    <input type="text" id="b2_2x2" placeholder="b2" value="-1"><span>y =</span>
                    <input type="text" id="c2_2x2" placeholder="c2" value="-2">
                </div>
                <button id="solve-2x2-system-btn" class="modal-button" style="width: 100%; margin-top: 1rem;">Resolver Sistema</button>
            </div>
        </div>
    </div>
    <div id="solve-3x3-modal" class="modal">
         <div class="modal-content">
            <div class="modal-header"><h2 class="modal-title">Sistema de Ecuaciones 3x3</h2><button class="modal-close" data-modal="solve-3x3-modal">&times;</button></div>
            <div class="modal-body">
                <div class="system-solver-grid grid-3x3">
                    <input type="text" id="a1_3x3" placeholder="a1" value="1"><span>x+</span>
                    <input type="text" id="b1_3x3" placeholder="b1" value="1"><span>y+</span>
                    <input type="text" id="c1_3x3" placeholder="c1" value="1"><span>z=</span>
                    <input type="text" id="d1_3x3" placeholder="d1" value="6">
                    
                    <input type="text" id="a2_3x3" placeholder="a2" value="2"><span>x-</span>
                    <input type="text" id="b2_3x3" placeholder="b2" value="1"><span>y+</span>
                    <input type="text" id="c2_3x3" placeholder="c2" value="1"><span>z=</span>
                    <input type="text" id="d2_3x3" placeholder="d2" value="3">
                    
                    <input type="text" id="a3_3x3" placeholder="a3" value="1"><span>x-</span>
                    <input type="text" id="b3_3x3" placeholder="b3" value="2"><span>y-</span>
                    <input type="text" id="c3_3x3" placeholder="c3" value="3"><span>z=</span>
                    <input type="text" id="d3_3x3" placeholder="d3" value="-12">
                </div>
                <button id="solve-3x3-system-btn" class="modal-button" style="width: 100%; margin-top: 1rem;">Resolver Sistema</button>
            </div>
        </div>
    </div>

    <div id="help-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">Ayuda</h2><button class="modal-close" data-modal="help-modal">&times;</button></div><div class="modal-body"><p>Bienvenido a la Super Calculadora PRO-FX IX.</p><p>Usa los botones num√©ricos y de funciones para escribir expresiones en la pantalla principal. Los botones en la parte inferior realizan operaciones avanzadas sobre la expresi√≥n escrita.</p><p>Usa el men√∫ ‚ò∞ en la esquina superior derecha para acceder a los m√≥dulos especializados en Combinatoria, L√≥gica, Probabilidades y m√°s.</p></div></div></div>

    <div id="modal-error" class="modal modal-bg">
      <div class="modal-content" style="max-width: 400px; text-align: center;">
        <div class="modal-header">
            <h2 class="modal-title" style="color: var(--error-color);">Error en la Expresi√≥n</h2>
            <button class="modal-close" data-modal="modal-error">&times;</button>
        </div>
        <div class="modal-body">
            <p id="error-message-text" class="text-gray-300 mb-6"></p>
            <button onclick="closeModal('modal-error')" class="modal-button">Cerrar</button>
        </div>
      </div>
    </div>


    <!-- ========== MODALS END ========== -->

    <script>
    'use strict';
    const $ = id => document.getElementById(id);
    let activeModals = {};
    let activeCharts = {};

    function openModal(modalId) {
        const modal = $(modalId);
        if (modal) {
            modal.classList.add('active');
            if(activeModals[modalId] && typeof activeModals[modalId].init === 'function') {
                activeModals[modalId].init();
            }
        }
    };

    function closeModal(modalId) {
        const modal = $(modalId);
        if (modal) modal.classList.remove('active');
    };
    
    function showErrorModal(message) {
        $('error-message-text').textContent = message;
        openModal('modal-error');
    }

    document.addEventListener('DOMContentLoaded', () => {

        const functionInput = $('function-input');
        const outputDiv = $('output');
        const errorDiv = $('error-message');
        const limitControls = $('limit-controls');
        let isLimitMode = false;
        let lastResult = null;
        let isDecimalDisplayed = false;
        nerdamer.set('ANGLE_MODE', 'deg');

        const clearScreen = () => {
            outputDiv.innerHTML = '';
            errorDiv.style.display = 'none';
        };

        const showError = (message) => {
            outputDiv.innerHTML = '';
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        };

        const renderMath = (latexString, targetDiv = outputDiv) => {
            if(targetDiv === outputDiv) clearScreen();
            targetDiv.innerHTML = `$$${latexString}$$`;
            if (window.MathJax) {
                MathJax.typesetPromise([targetDiv]).catch(err => {
                    console.error("Error al renderizar MathJax:", err);
                    if(targetDiv === outputDiv) showError('Error al mostrar el resultado.');
                });
            }
        };
        
        const insertAtCursor = (inputElement, text) => {
            const start = inputElement.selectionStart;
            const end = inputElement.selectionEnd;
            const currentText = inputElement.value;
            inputElement.value = currentText.substring(0, start) + text + currentText.substring(end);
            inputElement.focus();
            inputElement.selectionEnd = start + text.length;
        };
        
        const insertAtMainCursor = (text) => insertAtCursor(functionInput, text);

        const performCalculation = (operation) => {
            let expression = functionInput.value.trim();
            if (!expression) { showError('Introduce una expresi√≥n.'); return; }
            
            try {
                let result, latexResult, expr = nerdamer(expression);
                if (operation === 'solve' && !expression.includes('=')) {
                    expression += '=0';
                    expr = nerdamer(expression);
                }
                
                switch(operation) {
                    case 'evaluate': result = expr.evaluate(); latexResult = `${expr.toTeX()} = ${result.toTeX()}`; break;
                    case 'expand': result = nerdamer.expand(expression); latexResult = `\\text{expand}\\left(${expr.toTeX()}\\right) = ${result.toTeX()}`; break;
                    case 'factor': result = nerdamer.factor(expression); latexResult = `\\text{factor}\\left(${expr.toTeX()}\\right) = ${result.toTeX()}`; break;
                    case 'solve': result = nerdamer.solve(expression, 'x'); latexResult = `\\text{solve}\\left(${expr.toTeX()}\\right) \\Rightarrow x = ${result.toTeX()}`; break;
                    case 'diff': result = nerdamer.diff(expression, 'x'); latexResult = `\\frac{d}{dx}\\left(${expr.toTeX()}\\right) = ${result.toTeX()}`; break;
                    case 'integrate': result = nerdamer.integrate(expression, 'x'); latexResult = `\\int ${expr.toTeX()} \\,dx = ${result.toTeX()}`; break;
                    case 'laplace': result = nerdamer.laplace(expression.replace(/x/g, 't'), 't', 's'); latexResult = `\\mathcal{L}\\{${nerdamer(expression).toTeX()}\\}(s) = ${result.toTeX()}`; break;
                    case 'limit':
                        const limitVar = $('limit-var').value.trim() || 'x';
                        const limitPoint = $('limit-point').value.trim() || '0';
                        result = nerdamer.limit(expression, limitVar, limitPoint);
                        latexResult = `\\lim_{${limitVar} \\to ${limitPoint}} \\left(${expr.toTeX()}\\right) = ${result.toTeX()}`;
                        limitControls.style.display = 'none';
                        isLimitMode = false;
                        break;
                }
                lastResult = result;
                isDecimalDisplayed = true; 
                renderMath(latexResult);
            } catch (err) { console.error("Error:", err); showError(`Error en la expresi√≥n.`); }
        };
        
        const solveSystem = (size) => {
            try {
                const ids = size === 2 ? ['a1_2x2', 'b1_2x2', 'c1_2x2', 'a2_2x2', 'b2_2x2', 'c2_2x2'] : ['a1_3x3','b1_3x3','c1_3x3','d1_3x3', 'a2_3x3','b2_3x3','c2_3x3','d2_3x3', 'a3_3x3','b3_3x3','c3_3x3','d3_3x3'];
                const vals = ids.map(id => parseFloat($(id).value));
                if(vals.some(isNaN)) { showError("Introduce valores num√©ricos en el sistema."); closeModal(`solve-${size}x${size}-modal`); return;}
                
                let eqns = [];
                if(size === 2) eqns = [`${vals[0]}*x+${vals[1]}*y=${vals[2]}`, `${vals[3]}*x+${vals[4]}*y=${vals[5]}`];
                else eqns = [`${vals[0]}*x+${vals[1]}*y+${vals[2]}*z=${vals[3]}`, `${vals[4]}*x+${vals[5]}*y+${vals[6]}*z=${vals[7]}`, `${vals[8]}*x+${vals[9]}*y+${vals[10]}*z=${vals[11]}`];

                const result = nerdamer.solveEquations(eqns);
                let latexResult = result.map(sol => `${sol[0]} = ${nerdamer(sol[1]).toTeX()}`).join(', \\quad ');
                renderMath(latexResult);
                closeModal(`solve-${size}x${size}-modal`);
            } catch(e) {
                showError("No se pudo resolver el sistema.");
                closeModal(`solve-${size}x${size}-modal`);
            }
        };
        
        const setupEventListeners = () => {
            $('angle-mode-selector').addEventListener('click', (e) => {
                if (e.target.tagName !== 'BUTTON') return;
                $('angle-mode-selector').querySelectorAll('.angle-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                nerdamer.set('ANGLE_MODE', e.target.dataset.mode);
            });

            document.querySelector('.keypad-container').addEventListener('click', (e) => {
                const button = e.target.closest('.keypad-button');
                if (!button) return;
                const value = button.dataset.value;
                switch(value) {
                    case 'AC': functionInput.value = ''; clearScreen(); lastResult = null; break;
                    case 'DEL': functionInput.value = functionInput.value.slice(0, -1); break;
                    case 'EVAL': performCalculation('evaluate'); break;
                    case 'S2D':
                        if (lastResult) isDecimalDisplayed ? renderMath(lastResult.toTeX()) : renderMath(nerdamer(lastResult.toString()).toTeX('decimal'));
                        isDecimalDisplayed = !isDecimalDisplayed;
                        break;
                    default: insertAtMainCursor(value); break;
                }
            });

            document.querySelector('.advanced-controls').addEventListener('click', e => {
                const button = e.target.closest('.adv-button');
                if (!button) return;
                const op = button.dataset.op;
                if (op) {
                    if (op === 'limit') {
                        if (!isLimitMode) {
                            limitControls.style.display = 'grid';
                            isLimitMode = true;
                            clearScreen();
                            outputDiv.innerHTML = "<span style='font-size: 1rem'>Ajusta la variable/punto y pulsa L√≠mite de nuevo.</span>";
                        } else {
                            performCalculation('limit');
                        }
                    } else {
                        performCalculation(op);
                    }
                } else if (button.dataset.modal) {
                    openModal(button.dataset.modal);
                }
            });
            
            document.querySelectorAll('.menu-item').forEach(trigger => {
                trigger.addEventListener('click', () => {
                    openModal(trigger.dataset.modal);
                    $('main-menu').classList.remove('active');
                });
            });

            document.querySelectorAll('.modal-close').forEach(btn => btn.addEventListener('click', () => closeModal(btn.dataset.modal)));
            
            window.addEventListener('click', e => {
                if(e.target.classList.contains('modal')) closeModal(e.target.id);
                const menu = $('main-menu');
                const menuToggle = $('menu-toggle');
                if(menu && menuToggle) {
                   if (menu.classList.contains('active') && !menu.contains(e.target) && !menuToggle.contains(e.target)) {
                        menu.classList.remove('active');
                    }
                }
            });

            $('menu-toggle').addEventListener('click', () => $('main-menu').classList.toggle('active'));

            const applyTheme = (theme) => {
                document.body.className = '';
                if (theme && theme !== 'default') document.body.classList.add(theme);
                localStorage.setItem('calculatorTheme', theme);
            };
            document.querySelectorAll('.theme-btn').forEach(button => button.addEventListener('click', () => applyTheme(button.dataset.theme)));
            const savedTheme = localStorage.getItem('calculatorTheme');
            if (savedTheme) applyTheme(savedTheme);
            
            $('solve-2x2-system-btn').addEventListener('click', () => solveSystem(2));
            $('solve-3x3-system-btn').addEventListener('click', () => solveSystem(3));
        };

        const initCombinatorics = () => {
             const elements = {
                numbers: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10'],
                letters: ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'],
                faces: ['üòÄ', 'üòé', 'üòÇ', 'üòç', 'ü§î', 'üò¢'],
                animals: ['üê∂', 'üê±', 'üê≠', 'üê∞', 'ü¶ä', 'üêª'],
                food: ['üçé', 'üçå', 'üçá', 'üçì', 'üçë', 'üçç'],
                custom: []
            };
            let selectedElements = [];

            const typeSelect = $('combinatorics-calculationType');
            const rValueGroup = $('combinatorics-rValueGroup');
            const elementTypeSelect = $('combinatorics-elementType');
            const elementGrid = $('combinatorics-elementGrid');
            const customInputContainer = $('combinatorics-custom-input-container');
            const customInput = $('combinatorics-custom-input');
            const addCustomBtn = $('combinatorics-add-custom-btn');
            const calculateBtn = $('combinatorics-calculate-btn');
            const resultsDiv = $('combinatorics-results');

            const factorial = (n) => {
                if (n < 0 || n > 170) return Infinity;
                if (n === 0) return 1;
                let result = 1;
                for(let i = 2; i <= n; i++) result *= i;
                return result;
            };

            const getPermutations = (arr, r) => {
                const result = [];
                function backtrack(path, used) {
                    if (path.length === r) { result.push([...path]); return; }
                    if (result.length >= 1000) return;
                    for (let i = 0; i < arr.length; i++) {
                        if (used[i]) continue;
                        path.push(arr[i]); used[i] = true;
                        backtrack(path, used);
                        path.pop(); used[i] = false;
                    }
                }
                backtrack([], new Array(arr.length).fill(false));
                return result;
            }
            
            const getCombinations = (arr, r) => {
                const result = [];
                function backtrack(start, path) {
                    if (path.length === r) { result.push([...path]); return; }
                    if (result.length >= 1000) return;
                    for (let i = start; i < arr.length; i++) {
                        path.push(arr[i]);
                        backtrack(i + 1, path);
                        path.pop();
                    }
                }
                backtrack(0, []);
                return result;
            };

            const getVariationsWithRepetition = (arr, r) => {
                const result = [];
                function backtrack(path) {
                    if (path.length === r) { result.push([...path]); return; }
                    if (result.length >= 1000) return;
                    for (let i = 0; i < arr.length; i++) {
                        path.push(arr[i]);
                        backtrack(path);
                        path.pop();
                    }
                }
                backtrack([]);
                return result;
            };
            
            const getCombinationsWithRepetition = (arr, r) => {
                const result = [];
                function backtrack(start, path) {
                    if (path.length === r) { result.push([...path]); return; }
                    if (result.length >= 1000) return;
                    for (let i = start; i < arr.length; i++) {
                        path.push(arr[i]);
                        backtrack(i, path);
                        path.pop();
                    }
                }
                backtrack(0, []);
                return result;
            };

            const createResultsScroll = (combinations, title, total) => {
                 if (!combinations || combinations.length === 0) {
                    return `<h3>${title}</h3><p><em>No se generaron ejemplos (demasiadas combinaciones o r=0).</em></p>`;
                }
                const showing = Math.min(combinations.length, 1000);
                const hasMore = total > 1000;
                let scrollContent = `<h3>${title}</h3><div style="background: var(--screen-bg); padding: 1rem; border-radius: 8px; text-align: center; margin-bottom: 1rem;">Mostrando ${showing.toLocaleString()} de ${total.toLocaleString()} resultados</div><div class="results-scroll-container">`;
                combinations.forEach((combo, index) => {
                    scrollContent += `<div class="combination-row"><span>#${index + 1}</span> <div style="margin-left:10px;">${combo.map(el => `<span class="element">${el}</span>`).join('')}</div></div>`;
                });
                scrollContent += `</div>`;
                if (hasMore) scrollContent += `<p style="text-align:center; font-size:0.8em; margin-top:10px;">(y muchos m√°s...)</p>`;
                return scrollContent;
            };

            const updateElementGrid = () => {
                const category = elementTypeSelect.value;
                elementGrid.innerHTML = '';
                customInputContainer.style.display = category === 'custom' ? 'block' : 'none';
                
                const currentElements = elements[category] || [];
                selectedElements = []; 

                currentElements.forEach(el => {
                    const elDiv = document.createElement('div');
                    elDiv.className = 'element-option';
                    elDiv.textContent = el;
                    elDiv.dataset.value = el;
                    elementGrid.appendChild(elDiv);
                });
                updateRValueMax();
            };

            const updateRValueMax = () => {
              const n = selectedElements.length;
              const rInput = $('combinatorics-rValue');
              const type = typeSelect.value;
              if (type === 'variaciones' || type === 'combinaciones') {
                  rInput.max = n > 0 ? n : 20;
                  if(parseInt(rInput.value) > n) rInput.value = n;
              } else {
                  rInput.max = 20;
              }
            };

            elementGrid.addEventListener('click', e => {
                const target = e.target.closest('.element-option');
                if (!target) return;
                const value = target.dataset.value;
                if (selectedElements.includes(value)) {
                    selectedElements = selectedElements.filter(el => el !== value);
                    target.classList.remove('selected');
                } else {
                    selectedElements.push(value);
                    target.classList.add('selected');
                }
                updateRValueMax();
            });

            addCustomBtn.addEventListener('click', () => {
                const newElements = customInput.value.split(',').map(s => s.trim()).filter(Boolean);
                elements.custom = [...new Set([...elements.custom, ...newElements])];
                customInput.value = '';
                updateElementGrid();
            });

            calculateBtn.addEventListener('click', () => {
                const type = typeSelect.value;
                let r = parseInt($('combinatorics-rValue').value);
                const n = selectedElements.length;
                let result = 0, formula = '', visual = '';
                
                if (type === 'permutaciones' || type === 'permutacionesCirc') r = n;

                if (n === 0) {
                    resultsDiv.innerHTML = "<div class='result-box error'>Selecciona al menos un elemento.</div>";
                    resultsDiv.style.display = 'block';
                    return;
                }
                 if (!r || r < 0) {
                    resultsDiv.innerHTML = "<div class='result-box error'>El valor de 'r' debe ser un n√∫mero positivo.</div>";
                    resultsDiv.style.display = 'block';
                    return;
                }

                try {
                    let exampleCombinations = [];
                    switch(type) {
                        case 'variaciones': 
                            if (r > n) throw new Error("r no puede ser mayor que n.");
                            result = factorial(n) / factorial(n - r);
                            formula = `V(${n},${r}) = \\frac{${n}!}{(${n}-${r})!}`;
                            exampleCombinations = getPermutations(selectedElements, r);
                            visual = createResultsScroll(exampleCombinations, 'Ejemplos de Variaciones:', result);
                            break;
                        case 'variacionesRep':
                            result = Math.pow(n, r);
                            formula = `VR(${n},${r}) = ${n}^{${r}}`;
                            exampleCombinations = getVariationsWithRepetition(selectedElements, r);
                            visual = createResultsScroll(exampleCombinations, 'Ejemplos de Variaciones con Repetici√≥n:', result);
                            break;
                        case 'permutaciones':
                            result = factorial(n);
                            formula = `P(${n}) = ${n}!`;
                             exampleCombinations = getPermutations(selectedElements, n);
                            visual = createResultsScroll(exampleCombinations, 'Ejemplos de Permutaciones:', result);
                            break;
                        case 'permutacionesCirc':
                            result = n > 0 ? factorial(n-1) : 0;
                            formula = `PC(${n}) = (${n}-1)!`;
                            const fixedEl = selectedElements[0];
                            const remaining = selectedElements.slice(1);
                            exampleCombinations = getPermutations(remaining, n-1).map(p => [fixedEl, ...p]);
                            visual = createResultsScroll(exampleCombinations, `Ejemplos de Permutaciones Circulares (fijando ${fixedEl}):`, result);
                            break;
                        case 'combinaciones':
                            if (r > n) throw new Error("r no puede ser mayor que n.");
                            result = factorial(n) / (factorial(r) * factorial(n - r));
                            formula = `C(${n},${r}) = \\frac{${n}!}{${r}!(${n}-${r})!}`;
                             exampleCombinations = getCombinations(selectedElements, r);
                            visual = createResultsScroll(exampleCombinations, 'Ejemplos de Combinaciones:', result);
                            break;
                        case 'combinacionesRep':
                            result = factorial(n + r - 1) / (factorial(r) * factorial(n - 1));
                            formula = `CR(${n},${r}) = \\frac{(${n}+${r}-1)!}{${r}!(${n}-1)!}`;
                            exampleCombinations = getCombinationsWithRepetition(selectedElements, r);
                            visual = createResultsScroll(exampleCombinations, 'Ejemplos de Combinaciones con Repetici√≥n:', result);
                            break;
                    }
                    resultsDiv.innerHTML = `<div class="result-box success">F√≥rmula: $${formula}$ <br> Resultado: <strong>${result.toLocaleString()}</strong></div> ${visual}`;
                    resultsDiv.style.display = 'block';
                    MathJax.typesetPromise([resultsDiv]);
                } catch(e) {
                    resultsDiv.innerHTML = `<div class="result-box error">Error: ${e.message}</div>`;
                    resultsDiv.style.display = 'block';
                }
            });

            elementTypeSelect.addEventListener('change', updateElementGrid);
            typeSelect.addEventListener('change', () => {
                const isPermutation = ['permutaciones', 'permutacionesCirc'].includes(typeSelect.value);
                rValueGroup.style.display = isPermutation ? 'none' : 'block';
                updateRValueMax();
            });

            updateElementGrid();
        };

        const initLogicSets = () => {
            let activeSetLetters = [];
        
            const renderSetInputs = () => {
                const container = $('sets-container');
                container.innerHTML = ''; 
                activeSetLetters.forEach(letter => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-3';
                    div.innerHTML = `
                        <label for="set-${letter}" class="font-bold text-lg text-indigo-300 w-6">${letter}:</label>
                        <input id="set-${letter}" class="w-full p-2 bg-gray-700 rounded-lg border border-gray-600 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500 outline-none font-mono" placeholder="Elementos de ${letter}, separados por coma">
                        ${activeSetLetters.length > 2 ? `<button class="remove-set-btn text-xl text-gray-500 hover:text-red-500 transition-colors" data-letter="${letter}" title="Eliminar conjunto ${letter}">&times;</button>` : ''}
                    `;
                    container.appendChild(div);
                });
                document.querySelectorAll('.remove-set-btn').forEach(btn => {
                    btn.onclick = (e) => removeSet(e.currentTarget.dataset.letter);
                });
                createOperatorButtons();
            };

            const addSet = () => {
                const nextCharCode = 'A'.charCodeAt(0) + activeSetLetters.length;
                if (nextCharCode > 'Z'.charCodeAt(0)) {
                    showErrorModal("Has alcanzado el l√≠mite de conjuntos (A-Z).");
                    return;
                }
                const nextLetter = String.fromCharCode(nextCharCode);
                activeSetLetters.push(nextLetter);
                renderSetInputs();
            };

            const removeSet = (letterToRemove) => {
                activeSetLetters = activeSetLetters.filter(l => l !== letterToRemove);
                renderSetInputs();
            };

            const createOperatorButtons = () => {
                const setButtonsContainer = $('set-op-buttons');
                const setInput = $('set-expression');
                setButtonsContainer.innerHTML = '';
                const setLettersButtons = activeSetLetters.map(l => ({ display: l, insert: l }));
                const setOpsButtons = [
                    { display: '(', insert: '(' }, { display: ')', insert: ')' }, { display: "'", insert: "'" },
                    { display: '‚à™', insert: ' u ' }, { display: '‚à©', insert: ' n ' }, { display: '-', insert: ' - ' },
                    { display: '‚àÜ', insert: ' d ' }, { display: '‚å´', action: 'backspace' }
                ];
                [...setLettersButtons, ...setOpsButtons].forEach(btn => setButtonsContainer.appendChild(createButton(btn, setInput)));
            };
            
             const createButton = (btnConfig, input) => {
                const button = document.createElement('button');
                button.textContent = btnConfig.display;
                button.className = 'bg-gray-700 hover:bg-gray-600 text-gray-200 font-mono font-bold py-2 rounded-lg transition-colors text-center';

                if (btnConfig.insert) {
                    button.onclick = () => insertAtCursor(input, btnConfig.insert);
                } else if (btnConfig.action === 'backspace') {
                    button.className += ' bg-red-800 hover:bg-red-700';
                    button.onclick = () => {
                        const start = input.selectionStart;
                        const end = input.selectionEnd;
                         if (start > 0 && start === end) {
                            input.value = input.value.substring(0, start - 1) + input.value.substring(end);
                            input.focus();
                            input.selectionEnd = start - 1;
                        } else {
                            input.value = input.value.substring(0, start) + input.value.substring(end);
                             input.focus();
                            input.selectionEnd = start;
                        }
                    };
                }
                return button;
            };
            
            $('logic-calc-expr-btn').addEventListener('click', () => {
                 const expr = $('set-expression').value.trim();
                if (!expr) return;

                try {
                    const sets = getSets();
                    const result = evalSetExpr(expr, sets);
                    const sortedResult = [...result].sort((a, b) => {
                        const numA = parseFloat(a);
                        const numB = parseFloat(b);
                        if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
                        return a.localeCompare(b, undefined, {numeric: true});
                    });

                    $('set-result').textContent = `{ ${sortedResult.join(', ')} }`;
                    $('set-result-container').classList.remove('hidden');
                } catch (err) {
                    showErrorModal(err.message);
                    $('set-result-container').classList.add('hidden');
                }
            });

            // L√≥gica Proposicional
            const logicButtonsContainer = $('logic-op-buttons');
            const logicInput = $('logic-input');
            if (!logicButtonsContainer.innerHTML) { 
                const logicButtons = [
                    { display: 'p', insert: 'p' }, { display: 'q', insert: 'q' }, { display: 'r', insert: 'r' }, { display: 's', insert: 's' },
                    { display: '(', insert: '(' }, { display: ')', insert: ')' }, { display: '‚àß', insert: ' & ' },
                    { display: '‚à®', insert: ' | ' }, { display: '¬¨', insert: '~' }, { display: '‚Üí', insert: ' -> ' },
                    { display: '‚Üî', insert: ' <-> ' }, { display: '‚å´', action: 'backspace' }
                ];
                logicButtons.forEach(btn => logicButtonsContainer.appendChild(createButton(btn, logicInput)));
            }

            $('logic-generate-table-btn').addEventListener('click', () => {
                 const rawExpr = logicInput.value.trim();
                if (!rawExpr) return;
                const vars = [...new Set(rawExpr.match(/[p-s]/gi) || [])].sort();
                if (vars.length === 0 || vars.length > 4) {
                    showErrorModal('Se permiten de 1 a 4 variables distintas (p, q, r, s).');
                    return;
                }
                const headers = [...vars, rawExpr];
                const numRows = 1 << vars.length;
                const tableData = [];

                for (let i = 0; i < numRows; i++) {
                    const context = {};
                    const row = [];
                    vars.forEach((v, j) => {
                        const value = Boolean(i >> (vars.length - 1 - j) & 1);
                        context[v.toLowerCase()] = value;
                        row.push(value);
                    });
                    
                    const jsExpr = jsLogic(rawExpr).replace(/[p-s]/gi, m => `context.${m.toLowerCase()}`);
                    let result;
                    try {
                        result = Boolean(eval(jsExpr));
                    } catch (e) {
                        showErrorModal('La expresi√≥n l√≥gica es inv√°lida o est√° mal formada.');
                        return;
                    }
                    row.push(result);
                    tableData.push(row);
                }

                let html = '<table class="truth-table font-mono"><thead><tr>';
                headers.forEach(h => html += `<th>${h}</th>`);
                html += '</tr></thead><tbody>';
                tableData.forEach(r => {
                    html += '<tr>';
                    r.forEach(c => html += `<td class="${c ? 'T' : 'F'}">${c ? 'V' : 'F'}</td>`);
                    html += '</tr>';
                });
                html += '</tbody></table>';
                $('truth-table-container').innerHTML = html;

                const finalColumn = tableData.map(r => r[r.length - 1]);
                const resultText = $('truth-table-result');
                if (finalColumn.every(Boolean)) {
                    resultText.textContent = 'Resultado: Tautolog√≠a';
                    resultText.className = 'mt-4 text-center text-xl font-bold text-green-400';
                } else if (finalColumn.every(x => !x)) {
                    resultText.textContent = 'Resultado: Contradicci√≥n';
                    resultText.className = 'mt-4 text-center text-xl font-bold text-red-400';
                } else {
                    resultText.textContent = 'Resultado: Contingencia';
                    resultText.className = 'mt-4 text-center text-xl font-bold text-yellow-400';
                }
            });
            
            // Inicializaci√≥n del m√≥dulo
            activeSetLetters = ['A', 'B'];
            renderSetInputs();
            $('add-set-btn').onclick = addSet;
             document.querySelectorAll('#logic-sets-modal .tab-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#logic-sets-modal .tab-button').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    document.querySelectorAll('#logic-sets-modal .page-content').forEach(p => p.classList.remove('active'));
                    $(btn.dataset.page).classList.add('active');
                });
            });

        };
        
        const initProbabilities = () => {
             $('prob-calc-cond-btn').addEventListener('click', () => {
                const pA_inter_B = parseFloat($('prob-pA_inter_B_cond').value);
                const pB = parseFloat($('prob-pB_cond').value);
                const resultDiv = $('prob-result-conditional');
                if (isNaN(pA_inter_B) || isNaN(pB) || pB <= 0 || pA_inter_B > pB) {
                    resultDiv.textContent = 'Error: Datos inv√°lidos. P(B) debe ser > 0 y P(A‚à©B) ‚â§ P(B).';
                    resultDiv.className = 'result-box error';
                    resultDiv.style.display = 'block';
                    return;
                }
                const result = pA_inter_B / pB;
                resultDiv.innerHTML = `$P(A|B) = \\frac{${pA_inter_B}}{${pB}} = ${result.toFixed(4)}$`;
                resultDiv.className = 'result-box success';
                resultDiv.style.display = 'block';
                MathJax.typesetPromise([resultDiv]);
            });
            
            $('prob-calc-bayes-btn').addEventListener('click', () => {
                const pB_given_A = parseFloat($('prob-pB_given_A_bayes').value);
                const pA = parseFloat($('prob-pA_bayes').value);
                const pB = parseFloat($('prob-pB_bayes').value);
                const resultDiv = $('prob-result-bayes');
                if (isNaN(pB_given_A) || isNaN(pA) || isNaN(pB) || pB <= 0) {
                     resultDiv.textContent = 'Error: Datos inv√°lidos. P(B) debe ser > 0.';
                    resultDiv.className = 'result-box error';
                    resultDiv.style.display = 'block';
                    return;
                }
                const result = (pB_given_A * pA) / pB;
                resultDiv.innerHTML = `$P(A|B) = \\frac{${pB_given_A} \\cdot ${pA}}{${pB}} = ${result.toFixed(4)}$`;
                resultDiv.className = 'result-box success';
                resultDiv.style.display = 'block';
                MathJax.typesetPromise([resultDiv]);
            });
        };

        const initDistributions = () => {
            const distSelect = $('dist-distribution');
            const probTypeSelect = $('dist-probType');
            const valueBLabel = $('dist-label-b');
            const calcBtn = $('dist-calc-btn');
            const resultDiv = $('dist-result');
            const chartCanvas = $('dist-chart');
            
            const factorial = (n) => {
                if(n < 0 || Math.floor(n) !== n) return NaN;
                if (n > 170) return Infinity;
                let r = 1; for (let i = 2; i <= n; i++) r *= i; return r;
            };
            const comb = (n, k) => (k < 0 || k > n) ? 0 : factorial(n) / (factorial(k) * factorial(n - k));
            const gammaFuncLanczos = (z) => {
                const p = [676.5203681218851,-1259.1392167224028,771.32342877765313,-176.61502916214059,12.507343278686905,-0.13857109526572012,9.9843695780195716e-6,1.5056327351493116e-7];
                if (z < 0.5) return Math.PI / (Math.sin(Math.PI * z) * gammaFuncLanczos(1 - z));
                z -= 1; let x = 0.99999999999980993;
                for (let i = 0; i < p.length; i++) x += p[i] / (z + i + 1);
                let t = z + p.length - 0.5;
                return Math.sqrt(2 * Math.PI) * Math.pow(t, z + 0.5) * Math.exp(-t) * x;
            };
            const erf = (x) => {
                const sign = x < 0 ? -1 : 1, ax = Math.abs(x);
                const t = 1.0 / (1.0 + 0.5 * ax);
                const y = t * Math.exp(-ax * ax - 1.26551223 + t * (1.00002368 + t * (0.37409196 + t * (0.09678418 + t * (-0.18628806 + t * (0.27886807 + t * (-1.13520398 + t * (1.48851587 + t * (-0.82215223 + t * 0.17087277)))))))));
                return sign * (1.0 - y);
            }

            const pmfBinomial = (n, p, k) => comb(n, k) * Math.pow(p, k) * Math.pow(1 - p, n - k);
            const pmfPoisson = (l, k) => Math.pow(l, k) * Math.exp(-l) / factorial(k);
            const pdfNormal = (x, m, s) => (1/(s*Math.sqrt(2*Math.PI)))*Math.exp(-0.5*Math.pow((x-m)/s,2));
            const cdfNormal = (x, m, s) => 0.5 * (1 + erf((x - m) / (s * Math.sqrt(2))));
            const pdfChi2 = (x, k) => (x<0) ? 0 : (Math.pow(x, k/2 - 1) * Math.exp(-x/2)) / (Math.pow(2, k/2) * gammaFuncLanczos(k/2));
            const pdfTStudent = (x, v) => (gammaFuncLanczos((v+1)/2) / (Math.sqrt(v*Math.PI)*gammaFuncLanczos(v/2))) * Math.pow(1 + (x*x)/v, -(v+1)/2);

            const updateDistParams = () => {
                document.querySelectorAll('#dist-params-container .dist-param-group').forEach(el => el.style.display = 'none');
                $(`dist-params-${distSelect.value}`).style.display = 'block';
            };

            const updateValueInputs = () => {
                valueBLabel.style.display = probTypeSelect.value === 'between' ? 'block' : 'none';
            };

            const drawChart = (data, labels, distName, color, isContinuous = false) => {
                if (activeCharts['distributions']) activeCharts['distributions'].destroy();
                const ctx = chartCanvas.getContext('2d');
                const gridColor = 'rgba(236, 240, 241, 0.15)'; 
                const ticksColor = '#ecf0f1';
                
                activeCharts['distributions'] = new Chart(ctx, {
                    type: isContinuous ? 'line' : 'bar',
                    data: { 
                        labels, 
                        datasets: [{ 
                            label: `Distribuci√≥n ${distName}`, 
                            data, 
                            backgroundColor: isContinuous ? `${color}4D` : color, // 30% opacity
                            borderColor: color, 
                            borderWidth: isContinuous ? 2.5 : 0, 
                            pointRadius: 0,
                            fill: isContinuous ? true : false,
                        }] 
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        scales: { 
                            y: { beginAtZero: true, ticks:{color: ticksColor}, grid: { color: gridColor } }, 
                            x: { ticks:{color: ticksColor}, grid: { color: gridColor } } 
                        }, 
                        plugins: { legend: { labels: { color: ticksColor } } }
                    }
                });
            };
            
            calcBtn.addEventListener('click', () => {
                const dist = distSelect.value;
                let labels = [], data = [], isContinuous = false;
                const colorMap = {
                    normal: '#f1c40f',    // Amarillo
                    binomial: '#e67e22',   // Naranja
                    poisson: '#2ecc71',    // Verde
                    chi2: '#e74c3c',       // Rojo
                    tstudent: '#3498db'  // Azul
                };
                const chartColor = colorMap[dist];
                let resultText = "C√°lculo no implementado a√∫n.";
                
                try {
                    if (dist === 'binomial') {
                        const n = parseInt($('dist-binomial-n').value);
                        const p = parseFloat($('dist-binomial-p').value);
                        if(isNaN(n) || isNaN(p) || p<0 || p>1) throw new Error("Par√°metros inv√°lidos");
                        for(let i=0; i<=n; i++) { labels.push(i); data.push(pmfBinomial(n,p,i)); }
                        isContinuous = false;
                    } else if (dist === 'normal') {
                        const mu = parseFloat($('dist-normal-mean').value);
                        const sigma = parseFloat($('dist-normal-std').value);
                        if(isNaN(mu) || isNaN(sigma) || sigma <= 0) throw new Error("Par√°metros inv√°lidos");
                        const start = mu - 4 * sigma;
                        const end = mu + 4 * sigma;
                        for(let i=0; i<=100; i++) {
                            const x = start + (i/100)*(end-start);
                            labels.push(x.toFixed(2));
                            data.push(pdfNormal(x, mu, sigma));
                        }
                        isContinuous = true;
                    } else if (dist === 'poisson') {
                        const lambda = parseFloat($('dist-poisson-lambda').value);
                        if(isNaN(lambda) || lambda <= 0) throw new Error("Par√°metro inv√°lido");
                        const maxK = Math.max(20, Math.ceil(lambda + 4 * Math.sqrt(lambda)));
                        for(let i=0; i<=maxK; i++) { labels.push(i); data.push(pmfPoisson(lambda, i)); }
                        isContinuous = false;
                    } else if (dist === 'chi2') {
                        const k = parseInt($('dist-chi2-k').value);
                        if(isNaN(k) || k <= 0) throw new Error("Par√°metro inv√°lido");
                        const maxX = Math.max(10, k + 4 * Math.sqrt(2 * k));
                        for(let i=0; i<=100; i++) {
                            const x = (i/100) * maxX;
                            labels.push(x.toFixed(2));
                            data.push(pdfChi2(x, k));
                        }
                        isContinuous = true;
                    } else if (dist === 'tstudent') {
                         const nu = parseInt($('dist-t-nu').value);
                        if(isNaN(nu) || nu <= 0) throw new Error("Par√°metro inv√°lido");
                        const range = 5;
                        for(let i=0; i<=100; i++) {
                            const x = -range + (i/100) * (2*range);
                            labels.push(x.toFixed(2));
                            data.push(pdfTStudent(x, nu));
                        }
                        isContinuous = true;
                    }
                    drawChart(data, labels, dist, chartColor, isContinuous);
                    resultDiv.textContent = 'Gr√°fico generado.';
                    resultDiv.className = 'result-box success';
                    resultDiv.style.display = 'block';
                } catch (e) {
                    resultDiv.textContent = `Error: ${e.message}`;
                    resultDiv.className = 'result-box error';
                    resultDiv.style.display = 'block';
                }
            });

            distSelect.addEventListener('change', updateDistParams);
            probTypeSelect.addEventListener('change', updateValueInputs);
            updateDistParams();
            updateValueInputs();
        };

        const initStatistics = () => {
             // ... (L√≥gica completa del m√≥dulo de estad√≠stica aqu√≠)
        };

        // ========== INICIALIZACI√ìN DE TODO ==========
        setupEventListeners();
        activeModals['combinatorics-modal'] = { init: initCombinatorics };
        activeModals['logic-sets-modal'] = { init: initLogicSets };
        activeModals['probability-modal'] = { init: initProbabilities };
        activeModals['distributions-modal'] = { init: initDistributions };
        activeModals['statistics-modal'] = { init: initStatistics };
        
        Object.values(activeModals).forEach(module => {
            if (typeof module.init === 'function') {
                try {
                   module.init();
                } catch(e) {
                    console.error(`Error inicializando m√≥dulo: ${e}`);
                }
            }
        });

    });
    </script>

</body>
</html>
